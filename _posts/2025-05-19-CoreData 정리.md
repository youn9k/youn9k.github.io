---
title: "[Swift]CoreData ì •ë¦¬"
date: 2025-05-19 12:00 +0900
categories:
  - ğŸ iOS
  - Swift
tags:
  - CoreData
  - ë°ì´í„°ë² ì´ìŠ¤
---

## CoreDataë€?

CoreDataëŠ” Appleì—ì„œ ì œê³µí•˜ëŠ” ê°ì²´ ê·¸ë˜í”„(Object Graph) ë° ì˜ì†ì„±(Persistence) ê´€ë¦¬ í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.
SQLiteë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ë¡œë„ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ë‹¨ìˆœíˆ ë°ì´í„°ë² ì´ìŠ¤ ê¸°ëŠ¥ë¿ë§Œ ì•„ë‹ˆë¼ ê°ì²´ ê°„ì˜ ê´€ê³„ ê´€ë¦¬, ìƒíƒœ ì¶”ì , ë³€ê²½ ê°ì§€, iCould ì—°ë™, Undo/Redo, Lazy Loading ë“± ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

## ê°ì²´ ê·¸ë˜í”„ë€?

ê°ì²´ ê·¸ë˜í”„ë€ ì°¸ì¡°ë¥¼ í†µí•´ ì„œë¡œ ì—°ê²°ë˜ì–´ ìˆëŠ” ê°ì²´ë“¤ì˜ êµ¬ì¡°ë¥¼ ë§í•©ë‹ˆë‹¤.
ì•„ë˜ ì½”ë“œ ì˜ˆì‹œë¥¼ ë³´ë©´ Personê³¼ DogëŠ” ì„œë¡œ ì°¸ì¡°ë¥¼ ê°€ì§€ê³  ìˆê³ , ì´ë¥¼ ë„ì‹í™”í•˜ë©´ ê·¸ë˜í”„ í˜•íƒœë¡œ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
CoreDataëŠ” ì´ ê°ì²´ë“¤ ì‚¬ì´ì˜ ê´€ê³„ë¥¼ ì •ì˜í•˜ê³ , ì´ë¥¼ ì €ì¥ì†Œì— ê´€ê³„í˜• ë°ì´í„°ì²˜ëŸ¼ ë³€í™˜í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.

```swift
class Person {
    var name: String
    var dog: Dog?
}

class Dog {
    var name: String
    weak var owner: Person?
}
```

## CoreDataì˜ ì €ì¥ êµ¬ì¡°

CoreDataì˜ ì €ì¥ êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ì€ ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

![](/assets/img/post/2025/024.png)


```
NSManagedObject // DBì— ì €ì¥ë  ê°ì²´
    â¬‡ï¸
NSManagedObjectContext // ë³€ê²½ ì‚¬í•­ì„ ì¶”ì í•˜ëŠ” ì‘ì—… ê³µê°„
    â¬‡ï¸
NSPersistentStoreCoordinator // ì €ì¥ì†Œì™€ Contextë¥¼ ì—°ê²°
    â¬‡ï¸
ì €ì¥ì†Œ (SQLite, CloudKit, In-Memory ë“±)
```

NSManagedObject: CoreDataë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìƒì„± ë° ê´€ë¦¬ë˜ëŠ” ê°ì²´ë¡œ, ì†ì„± ë° ê´€ê³„ë¥¼ í¬í•¨í•˜ë©° DataBaseì˜ Scheme ì—­í• ì„ í•©ë‹ˆë‹¤.

NSManagedObjectContext: íŠ¸ëœì­ì…˜ ë‹¨ìœ„ì˜ ì‘ì—… ê³µê°„ìœ¼ë¡œ, ë³€ê²½ì‚¬í•­ì„ ì¶”ì í•˜ê³  save() ë¥¼ í†µí•´ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

NSPersistentStoreCoordinator: ì‹¤ì œ ì €ì¥ì†Œì™€ Contextë¥¼ ì—°ê²°í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

![](/assets/img/post/2025/025.png)

NSPersistentContainerëŠ” CoreData Stackì„ êµ¬ì„±í•˜ëŠ”ë° í•„ìš”í•œ ê°ì²´ë“¤ì„ ë‹´ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. CoreDataë¥¼ ì„¤ì •í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.


## NSManagedObject ìƒì„±

`MyModel.xcdatamodeld` ë¼ëŠ” CoreData Modelì„ ë§Œë“  ë‹¤ìŒ,

![](/assets/img/post/2025/026.png)

Entites ì— ì €ì¥í•˜ê³  ì‹¶ì€ ê°ì²´ë¥¼ ëª¨ë¸ë§í•˜ë©´

![](/assets/img/post/2025/027.png)

NSManagedObjectê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ê³ , ì½”ë“œì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

![](/assets/img/post/2025/028.png)

## ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ CoreData ë‹¤ë£¨ê¸°

CoreDataì—ì„œ ì´ë¤„ì§€ëŠ” íŠ¸ëœì­ì…˜ë“¤ì€ NSManagedObjectContextë¥¼ í†µí•´ ì´ë¤„ì§€ëŠ”ë°, ContextëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë©”ì¸ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ ëŒ€ëŸ‰ì˜ ë°ì´í„° ì²˜ë¦¬ë‚˜ ì €ì¥ ì‘ì—…ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•Šìœ¼ë©´ ë©”ì¸ìŠ¤ë ˆë“œê°€ ë²„ë²…ì´ê²Œ ë˜ì–´ UXì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### NSManagedObjectContextConcurrencyType

ì´ë¥¼ ìœ„í•´ CoreDataëŠ” Contextë¥¼ ì´ˆê¸°í™”í•  ë•Œ `NSManagedObjectContextConcurrencyType` ì˜µì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.
ì˜µì…˜ìœ¼ë¡œ `.mainQueue` ë˜ëŠ” `.privateQueue` ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê³ , 
.mainQueue ëŠ” ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ .privateQueueëŠ” ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ UIì™€ ê´€ë ¨ëœ ì‘ì—…ë§Œ mainQueueì—ì„œ ìˆ˜í–‰í•˜ëŠ”ê²Œ ì¢‹ìŠµë‹ˆë‹¤.

ë˜ëŠ” newBackgroundContext() ë©”ì†Œë“œë¥¼ í†µí•´ ë‚´ë¶€ì ìœ¼ë¡œ .privateQueueConcurrencyTypeìœ¼ë¡œ ì„¤ì •ëœ Contextë¥¼ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```swift
let backgroundContext = persistentContainer.newBackgroundContext()
```

.mainQueueConcurrencyTypeìœ¼ë¡œ ì„¤ì •ëœ viewContextë„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
let viewContext = persistentContainer.viewContext
```

### perform, performAndWait

Contextì—ì„œì˜ ì‘ì—…ì€ perform ë˜ëŠ” performAndWaitì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
performì€ ë¹„ë™ê¸°, performAndWaitì€ ë™ê¸° ë°©ì‹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.

íì— ì‘ì—…ì´ ë“±ë¡ë˜ê³  ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ ë°ì´í„° ë ˆì´ìŠ¤ ë¬¸ì œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
// ë¹„ë™ê¸°
backgroundContext.perform {
    let entity = SomeEntity(context: backgroundContext)
    entity.title = "Test"
    try? backgroundContext.save()
}
// ë™ê¸°
backgroundContext.performAndWait {
    let entity = SomeEntity(context: backgroundContext)
    entity.title = "Test"
    try? backgroundContext.save()
}
```

### MergePolicy

ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ NSManagedObjectContextê°€ ë™ì¼í•œ ê°ì²´ë¥¼ ìˆ˜ì •í•˜ê³  ì €ì¥í•˜ë ¤ê³  í•˜ë©´ ì¶©ëŒ(Conflict)ì´ ë°œìƒí•©ë‹ˆë‹¤.

```swift
func saveAsync() {
    let viewContext = container.viewContext // ë©”ì¸ ìŠ¤ë ˆë“œ
    let bgContext = container.newBackgroundContext() // ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ

    // ë™ì¼í•œ ê°ì²´ ì°¸ì¡°
    let object1 = try? viewContext.existingObject(with: id) as? SomeEntity
    let object2 = try? bgContext.existingObject(with: id) as? SomeEntity

    // ìˆ˜ì •
    object1.title = "title1"
    object2.title = "title2"

    try? viewContext.save() // ì €ì¥ë¨
    bgContext.perform {
        // bgContextì˜ ìŠ¤ëƒ…ìƒ·ê³¼ dbì˜ ê°ì²´ ìƒíƒœê°€ ë‹¤ë¦„ì„ ê°ì§€
        // NSMergeConflict ë°œìƒ
        // mergePolicyê°€ .error(ê¸°ë³¸ê°’)ì´ë¯€ë¡œ ì €ì¥ ì‹¤íŒ¨
        try? bgContext.save()
    }
}
```

ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì •ì±…ì´ MergePolicyì…ë‹ˆë‹¤.

MergePolicyë¥¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ì€ .errorë¡œ ì¶©ëŒì´ ë°œìƒí–ˆì„ ë•Œ ì €ì¥ì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

MergePolicy ì¢…ë¥˜ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

`.error`: ì¶©ëŒ ì‹œ ì €ì¥ ì‹¤íŒ¨
`.mergeByPropertyObjectTrump`: í˜„ì¬ Context ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸° (ì¶©ëŒëœ ì†ì„±ë§Œ)
`.mergeByPropertyStoreTrump`: DB ê°’ì´ ìš°ì„ 
`.overwrite`: í˜„ì¬ Context ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸° (ê°ì²´ ì „ë¶€)
.`rollback`: í˜„ì¬ Contextì˜ ë³€ê²½ì‚¬í•­ì„ ëª¨ë‘ ë˜ëŒë¦¼

